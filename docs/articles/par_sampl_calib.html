<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="SWATrunR">
<title>Parameter sampling and model calibration • SWATplusR</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Parameter sampling and model calibration">
<meta property="og:description" content="SWATrunR">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-dark navbar-expand-lg bg-primary"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">SWATplusR</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.9.4</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/SWATrunR.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/par_sampl_calib.html">Parameter sampling and model calibration</a>
    <a class="dropdown-item" href="../articles/par_sensitivity.html">Parameter sensitivity analysis</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/chrisschuerz/SWATrunR/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Parameter sampling and model calibration</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/chrisschuerz/SWATrunR/blob/HEAD/vignettes/par_sampl_calib.Rmd" class="external-link"><code>vignettes/par_sampl_calib.Rmd</code></a></small>
      <div class="d-none name"><code>par_sampl_calib.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="aim-of-this-article">Aim of this article<a class="anchor" aria-label="anchor" href="#aim-of-this-article"></a>
</h2>
<p>This article should give you a general idea on how you can integrate
<code>SWATplusR</code> in typical model calibration routines. There are
many ways to approach model calibration, but one of the most frequent
ways is to sample a set of parameter combinations, run the model,
evaluate the simulation outputs and either perform further simulations
or consider the model as acceptably calibrated (well that usually does
not happen after one round of simulations). Therefore the article will
address the following tasks:</p>
<ul>
<li>Sampling SWAT parameter combinations using the two approaches,
random and Latin Hypercube Sampling (LHS)</li>
<li>Performing model simulations with <code>SWATplusR</code> (using
parallel processing to speed things up)</li>
<li>Evaluating model simulations with performance metrics which are
often used in hydrology</li>
</ul>
</div>
<div class="section level2">
<h2 id="r-packages">R packages<a class="anchor" aria-label="anchor" href="#r-packages"></a>
</h2>
<p>The examples below use different functions from several
<code>R</code> packages. I recommend to install and load already all
required packages at this point. I will not explain these packages here,
but I will refer to some of their functionality in the examples
below.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># If any of the packages is not installed already run the respective lines here.</span></span>
<span><span class="co"># General data science packages</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'dplyr'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'tibble'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'purrr'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'lubridate'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Latin Hypercube sampling</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'lhs'</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Hydrological model performance metrics</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">'hydroGOF'</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/chrisschuerz/SWATplusR" class="external-link">SWATplusR</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># General data science packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org" class="external-link">tidyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://purrr.tidyverse.org/" class="external-link">purrr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org" class="external-link">lubridate</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Latin Hypercube sampling</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bertcarnell/lhs" class="external-link">lhs</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Hydrological model performance metrics</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hzambran/hydroGOF" class="external-link">hydroGOF</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="parameter-sampling">Parameter sampling<a class="anchor" aria-label="anchor" href="#parameter-sampling"></a>
</h2>
<p>Two frequently used sampling strategies for parameter sampling are
simple generic random sampling and Latin Hypercube Sampling (LHS). You
can implement both sampling strategies quite easily in <code>R</code>.
To draw random uniform samples you can use the function
<code><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif()</a></code> from the base <code>R</code> package
<code>stats</code> <span class="citation">(<a href="#ref-Rcore2019">R
Core Team, 2019</a>)</span>. Different LHS sampling routines are
available with the <code>R</code> package <code>lhs</code> <span class="citation">(<a href="#ref-Carnell2019">Carnell, 2019</a>)</span>.
Other procedures, such as certain methods for parameter sensitivity
analysis require specifically tailored sampling schemes. These sampling
schemes are often provided with the respective sensitivity analysis
related <code>R</code> packages.</p>
<div class="section level3">
<h3 id="defining-parameter-boundaries">Defining parameter boundaries<a class="anchor" aria-label="anchor" href="#defining-parameter-boundaries"></a>
</h3>
<p>Before we can draw parameter samples we have to define:</p>
<ul>
<li>the parameters that we want to include in the parameter set</li>
<li>the type of change we want to apply to a parameter</li>
<li>and the ranges in which each parameter should be changed.</li>
</ul>
<p>The names of the parameters follow a specific syntax that controls
the type of parameter change and can include further conditions for a
parameter change. The parameter syntax is explained in the <a href="https://chrisschuerz.github.io/SWATplusR/articles/SWATplusR.html#changing-parameter-values" class="external-link">Get
started</a> section. If you are not familiar with the parameter name
syntax already I recommend you to have a look there first.</p>
<p>We can define the parameter names and the boundaries for the
parameter changes in a <code>tibble</code> <span class="citation">(<a href="#ref-Mueller2019">Müller and Wickham, 2019</a>)</span> that we
then use in the parameter sampling. I recommend to use a
<code>tibble</code> here rather than the synonymous
<code>data.frame</code> as the base <code>R</code> data frames may have
issues with more complex column names that we need here. The
<code>tibble</code> for the parameter boundaries is structured as
illustrated in the example below. We define a column name and assign two
values which represent the lower and the upper boundaries for possible
parameter changes. The example below uses 7 SWAT+ parameters that are
often included in a model calibration. The first line in the
<code>tibble</code> definition can for example be translated as follows:
We define the parameter <em>‘cn2’</em> which is an <em>‘.mgt’</em>
parameter and we want to change the initial parameter values by adding
or substracting absolute values (<em>‘abschg’</em>) in the range -15 to
10.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">'cn2.hru | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">15</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>                    <span class="st">'lat_ttime.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>                    <span class="st">'lat_len.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>                    <span class="st">'k.sol | change = pctchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>                    <span class="st">'awc.sol | change = pctchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">50</span>, <span class="fl">50</span><span class="op">)</span>,</span>
<span>                    <span class="st">'esco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                    <span class="st">'epco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="random-sampling-with-runif">Random sampling with <code>runif()</code><a class="anchor" aria-label="anchor" href="#random-sampling-with-runif"></a>
</h3>
<p>The most basic way to draw random parameter samples is to use the
base R function <code><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif()</a></code>. With <code><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif()</a></code> you
create a uniformly distributed vector. To draw a specific number of
parameter sets with <code><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif()</a></code> you have to create a vector
with that number of random values for each parameter and transform them
to their parameter ranges. Below you find a simple approach to create a
table of parameter combinations using a <code>map*()</code> function
from the functional programming package <code>purrr</code> <span class="citation">(<a href="#ref-Henry2019">Henry and Wickham,
2019</a>)</span>. Even if you do not fully understand what
<code><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df()</a></code> and the code below do you can use this as a recipe
for drawing random uniform samples. This approach should work in your
practical cases as well.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">n_sample</span> <span class="op">&lt;-</span> <span class="fl">250</span></span>
<span></span>
<span><span class="va">par_runif</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map_df</a></span><span class="op">(</span><span class="va">par_bound</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="va">n_sample</span>, <span class="va">.x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">.x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">par_runif</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 250 × 7</span></span></span>
<span><span class="co">#&gt;    `cn2.hru | change = abschg` lat_tti…¹ lat_l…² k.sol…³ awc.s…⁴ esco.…⁵ epco.…⁶</span></span>
<span><span class="co">#&gt;                          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>                        6.92     29.3     86.7   49.0    -<span style="color: #BB0000;">4.76</span>  0.932    0.513</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>                      -<span style="color: #BB0000;">14.5</span>      22.8     83.9  -<span style="color: #BB0000;">39.2</span>     3.80  0.210    0.605</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>                        2.91     38.1     19.0    7.93   20.0   0.761    0.351</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>                       -<span style="color: #BB0000;">4.74</span>     49.6     17.9   26.9    31.3   0.704    0.195</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>                       -<span style="color: #BB0000;">8.82</span>      5.02    93.9  -<span style="color: #BB0000;">45.0</span>   -<span style="color: #BB0000;">24.6</span>   0.196    0.719</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>                       -<span style="color: #BB0000;">5.16</span>     24.5     26.3   39.0   -<span style="color: #BB0000;">38.7</span>   0.406    0.665</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>                        1.62      7.16    62.0  -<span style="color: #BB0000;">35.0</span>    -<span style="color: #BB0000;">8.02</span>  0.512    0.206</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>                        8.59     42.4     45.5  -<span style="color: #BB0000;">48.4</span>    -<span style="color: #BB0000;">8.72</span>  0.651    0.887</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>                       -<span style="color: #BB0000;">2.77</span>     23.0     19.2   16.7   -<span style="color: #BB0000;">20.9</span>   0.105    0.691</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>                       -<span style="color: #BB0000;">9.72</span>     29.2     53.6   42.5    -<span style="color: #BB0000;">3.99</span>  0.044<span style="text-decoration: underline;">5</span>   0.309</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 240 more rows, and abbreviated variable names</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ¹​`lat_ttime.hru | change = absval`, ²​`lat_len.hru | change = absval`,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ³​`k.sol | change = pctchg`, ⁴​`awc.sol | change = pctchg`,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ⁵​`esco.hru | change = absval`, ⁶​`epco.hru | change = absval`</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="lhs-sampling-with-randomlhs">LHS sampling with <code>randomLHS()</code><a class="anchor" aria-label="anchor" href="#lhs-sampling-with-randomlhs"></a>
</h3>
<p>In a very similar way as the random sampling you can draw LHS samples
by using the function <code><a href="https://rdrr.io/pkg/lhs/man/randomLHS.html" class="external-link">randomLHS()</a></code> from the <code>lhs</code>
package. This is my preferred way to sample parameter combinations, as
the parameter combinations are better distributed over the parameter
space compared to random sampling. Again we can use the defined
parameter boundaries to sample the LHS parameter set. You can consider
the code below as a further recipe to perform a sampling in your
modeling cases as well. I put the code for the LHS sampling into a
function, as we might use the same function more often later on.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sample_lhs</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">n</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">n_par</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/lhs/man/randomLHS.html" class="external-link">randomLHS</a></span><span class="op">(</span>n <span class="op">=</span> <span class="va">n</span>, k <span class="op">=</span> <span class="va">n_par</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># Perform sampling</span></span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">.</span>, .name_repair <span class="op">=</span> <span class="st">'minimal'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># Convert to a tibble</span></span>
<span>    <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">par</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># Assign the parameter names with purrr</span></span>
<span>    <span class="fu"><a href="https://purrr.tidyverse.org/reference/map_dfr.html" class="external-link">map2_df</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">par</span>, <span class="op">~</span> <span class="op">(</span><span class="va">.x</span> <span class="op">*</span> <span class="op">(</span><span class="va">.y</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">-</span> <span class="va">.y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span> <span class="va">.y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="co"># Scale parameter ranges</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">par_lhs</span> <span class="op">&lt;-</span> <span class="fu">sample_lhs</span><span class="op">(</span><span class="va">par_bound</span>, <span class="fl">250</span><span class="op">)</span></span>
<span></span>
<span><span class="va">par_lhs</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 250 × 7</span></span></span>
<span><span class="co">#&gt;    `cn2.hru | change = abschg` lat_tti…¹ lat_l…² k.sol…³ awc.s…⁴ esco.…⁵ epco.…⁶</span></span>
<span><span class="co">#&gt;                          <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>                      -<span style="color: #BB0000;">13.7</span>      43.4     41.4    36.3    2.13 0.036<span style="text-decoration: underline;">3</span>    0.870</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>                       -<span style="color: #BB0000;">7.89</span>     47.2     89.2    21.8   31.8  0.261     0.554</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>                        8.02     15.6     72.4   -<span style="color: #BB0000;">12.5</span>  -<span style="color: #BB0000;">19.1</span>  0.671     0.174</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>                       -<span style="color: #BB0000;">1.23</span>      1.49    81.7    22.9  -<span style="color: #BB0000;">35.7</span>  0.619     0.617</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>                        6.55     47.4     58.3   -<span style="color: #BB0000;">43.5</span>   48.7  0.180     0.586</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>                      -<span style="color: #BB0000;">13.6</span>      22.3     43.9   -<span style="color: #BB0000;">39.0</span>  -<span style="color: #BB0000;">24.1</span>  0.990     0.349</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>                       -<span style="color: #BB0000;">9.97</span>      2.21    94.1    35.3   22.9  0.045<span style="text-decoration: underline;">3</span>    0.817</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>                       -<span style="color: #BB0000;">2.17</span>     42.8     44.8    19.7   15.5  0.009<span style="text-decoration: underline;">74</span>   0.666</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>                        2.92     24.3     88.5   -<span style="color: #BB0000;">36.5</span>   40.6  0.207     0.312</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>                       -<span style="color: #BB0000;">5.88</span>     13.9     37.3    17.8  -<span style="color: #BB0000;">29.2</span>  0.890     0.393</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 240 more rows, and abbreviated variable names</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ¹​`lat_ttime.hru | change = absval`, ²​`lat_len.hru | change = absval`,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ³​`k.sol | change = pctchg`, ⁴​`awc.sol | change = pctchg`,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ⁵​`esco.hru | change = absval`, ⁶​`epco.hru | change = absval`</span></span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="a-small-calibration-example">A small calibration example<a class="anchor" aria-label="anchor" href="#a-small-calibration-example"></a>
</h2>
<p>There are endless ways to approach a SWAT model calibration. Below I
demonstrate a small workflow that could give some ideas on what to
consider in a model calibration. The example shows a bare minimum
example for calibrating discharge. Real case studies will very likely
require more extensive calibration and evaluation depending of the
scopes of a model setup. In SWAT model applications other variables such
as the in-stream sediment load, or nutrient loads may be the variables
of interest. This is not the focus of this small example.</p>
<div class="section level3">
<h3 id="definition-for-the-simulation-experiments">Definition for the simulation experiments<a class="anchor" aria-label="anchor" href="#definition-for-the-simulation-experiments"></a>
</h3>
<p>For this small calibration example we will again use the SWAT+ demo
project to perform the model simulations. You can load the demo path
again by running <code><a href="../reference/load_demo.html">load_demo()</a></code>, or use the demo path from
previous examples, if you do have the demo project already on your hard
drive. Loading the existing demo with <code><a href="../reference/load_demo.html">load_demo()</a></code> in the
same path will not overwrite the existing demo, but will return the path
to the demo project that you can further use.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># The path where the SWAT demo project will be written</span></span>
<span><span class="va">demo_path</span> <span class="op">&lt;-</span> <span class="st">'Define:/your/path'</span></span>
<span></span>
<span><span class="co"># Loading a SWAT+ demo project</span></span>
<span><span class="va">path_plus</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_demo.html">load_demo</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">'project'</span>,</span>
<span>                       path <span class="op">=</span> <span class="va">demo_path</span>,</span>
<span>                       version <span class="op">=</span> <span class="st">'plus'</span><span class="op">)</span></span></code></pre></div>
<p>A few catchment properties that we will use later on in the example I
will define already at this point.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">#Catchment area</span></span>
<span><span class="va">cmt_area</span> <span class="op">&lt;-</span> <span class="fl">22028300</span> <span class="co">#m2</span></span>
<span><span class="co"># Average annual precipitation from station data</span></span>
<span><span class="va">pcp_avann_obs</span> <span class="op">&lt;-</span> <span class="fl">1069.2</span> <span class="co">#mm</span></span>
<span><span class="co"># Average annual discharge in mm from station data</span></span>
<span><span class="va">q_avann_obs</span> <span class="op">&lt;-</span> <span class="fl">223.8</span> <span class="co">#mm</span></span>
<span><span class="co"># Average annual ET estimated from pcp and q</span></span>
<span><span class="va">et_avann_est</span> <span class="op">&lt;-</span> <span class="va">pcp_avann_obs</span> <span class="op">-</span> <span class="va">q_avann_obs</span></span></code></pre></div>
<p>We will only perform simulations for short time periods of only a few
years to keep the computation times low, although we would have much
longer observations. For our small example we define a calibration
period from 2006 to 2009 with 3 years warm up period and a validation
period from 2010 to 2012 again with 3 years warm up.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Calibration period</span></span>
<span><span class="va">cal_start</span> <span class="op">&lt;-</span> <span class="fl">20030101</span></span>
<span><span class="va">cal_start_print</span> <span class="op">&lt;-</span> <span class="fl">20060101</span></span>
<span><span class="va">cal_end</span> <span class="op">&lt;-</span> <span class="fl">20091231</span></span>
<span></span>
<span><span class="co"># Validation period</span></span>
<span><span class="va">val_start</span> <span class="op">&lt;-</span> <span class="fl">20070101</span></span>
<span><span class="va">val_start_print</span> <span class="op">&lt;-</span> <span class="fl">20100101</span></span>
<span><span class="va">val_end</span> <span class="op">&lt;-</span> <span class="fl">20121231</span></span></code></pre></div>
<p>We will perform the calibration only for discharge. You can load
observed daily discharge data for the demo catchment with
<code><a href="../reference/load_demo.html">load_demo()</a></code>. We will already split the observation data
into the defined calibration and validation periods.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qobs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/load_demo.html">load_demo</a></span><span class="op">(</span>dataset <span class="op">=</span> <span class="st">'obs'</span><span class="op">)</span> </span>
<span></span>
<span><span class="va">qobs_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">qobs</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2006</span><span class="op">:</span><span class="fl">2009</span><span class="op">)</span></span>
<span><span class="va">qobs_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">qobs</span>, <span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fl">2010</span><span class="op">:</span><span class="fl">2012</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="first-checks">First checks<a class="anchor" aria-label="anchor" href="#first-checks"></a>
</h3>
<p>First checks of a model setup do not necessarily involve
<code>R</code> or <code>SWATplusR</code>, but the value of this step is
undeniably large. Before starting with any model calibration, run your
initial model setup (for example in the SWAT+Editor) and check your
aggregated and general model results for example with <em>SWATcheck</em>
which is implemented in the SWAT+Editor. This simple step gives you a
good idea if your model inputs, such as the mean annual precipitation
and temperature are plausible. Is the potential evapotranspiration
plausible? At this point the model should already include the farm
management that you want to implement in the model simulations. Do the
plant biomass and the crop yields look plausible to you? Are crop yields
in your region (e.g. from agricultural statistics) comparable to the
simulated crop yields? Make sure to do these initial checks and solve
any issues already at this stage of model development. Any model
calibration with wrong inputs or implausible configurations is a waste
of time and going back to this step and fixing the present issues is
very likely inevitable.</p>
</div>
<div class="section level3">
<h3 id="constraining-et-and-keeping-an-eye-on-crop-yields">Constraining ET and keeping an eye on crop yields<a class="anchor" aria-label="anchor" href="#constraining-et-and-keeping-an-eye-on-crop-yields"></a>
</h3>
<p>In a first calibration step I recommend to check the fractions of the
water input (i.e. precipitation) which are removed from the system by
evapotranspiration (ET) and which remain in the catchment system (as
different fractions of runoff). This analysis assumes that there is no
major storage component (e.g. ground water storage) that fills up in the
simulation time period. Thus this analysis should always include a
longer simulation period (~10 years. More, even better!). The separation
of precipitation into these two general fractions is mostly controlled
by only a few SWAT parameters. The most relevant are <em>esco</em> (Soil
evaporation compensation factor), <em>epco</em> (Plant uptake
compensation factor), and <em>awc</em> (Available soil water capacity).
We include the three parameters in a simulation experiment to learn how
changes in the parameter values control the simulation of annual ET (and
the remaining discharge) sums. These parameters may be included in
further calibration steps, but there is a chance to constrain their
parameter ranges already in this step and exclude parameter ranges that
would result in implausible model simulations. This conceptual idea is
somehow related to the soft calibration that is available in SWAT+, but
the overall approach is different.</p>
<p>In this first round of simulations we will use the entire ranges (0
to 1) of <em>esco</em> and <em>epco</em> and vary their values by
reassigning new parameter values (<code>'change = absval'</code>).
<em>awc</em> does already have initial values derived from the soil
input data. Thus, rewriting parameter values is not recommended. In the
case of spatially distributed parameter values we could perform relative
changes of the parameter values or add absolute values. In this case we
change the initial values of <em>awc</em> by +/- 25%.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">'esco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                    <span class="st">'epco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                    <span class="st">'awc.sol | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.25</span>, <span class="fl">0.25</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We only analyze three parameters here. So it is not necessary to draw
large parameter sets and testing 40 to 100 parameter combinations may be
enough to analyze patterns in ET.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_et_yld</span> <span class="op">&lt;-</span> <span class="fu">sample_lhs</span><span class="op">(</span><span class="va">par_bound</span>, <span class="fl">40</span><span class="op">)</span></span>
<span></span>
<span><span class="va">par_et_yld</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 40 × 3</span></span></span>
<span><span class="co">#&gt;    `esco.hru | change = absval` `epco.hru | change = absval` awc.sol | change …¹</span></span>
<span><span class="co">#&gt;                           <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>                        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>               <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>                       0.376                        0.094<span style="text-decoration: underline;">7</span>              0.234 </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>                       0.582                        0.660              -<span style="color: #BB0000;">0.095</span><span style="color: #BB0000; text-decoration: underline;">2</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>                       0.270                        0.996              -<span style="color: #BB0000;">0.040</span><span style="color: #BB0000; text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>                       0.679                        0.876              -<span style="color: #BB0000;">0.059</span><span style="color: #BB0000; text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>                       0.077<span style="text-decoration: underline;">5</span>                       0.905              -<span style="color: #BB0000;">0.011</span><span style="color: #BB0000; text-decoration: underline;">9</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>                       0.780                        0.607              -<span style="color: #BB0000;">0.113</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>                       0.195                        0.297              -<span style="color: #BB0000;">0.072</span><span style="color: #BB0000; text-decoration: underline;">3</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>                       0.042<span style="text-decoration: underline;">5</span>                       0.130               0.025<span style="text-decoration: underline;">0</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>                       0.918                        0.804              -<span style="color: #BB0000;">0.242</span> </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>                       0.574                        0.176               0.054<span style="text-decoration: underline;">4</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 30 more rows, and abbreviated variable name</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   ¹​`awc.sol | change = relchg`</span></span></span></code></pre></div>
<p>In this simulation experiment we will extract two outputs that we
will analyze to get a better picture of ET and crop yields. Analyzing
crop yields in larger model setups can be challenging, particularly when
crop rotations are implemented in the management schedules (which is the
case in the demo model setup). With crop rotations crop yields must be
analyzed with great care in order to not mix up the yields of different
crops. In such a case I would recommend to analyze the yields for
individual HRUs and years or aggregate the data for different HRUs where
you know that the same crop was planted and harvested in the same year.
For our simple example I will show both approaches. Yet, an aggregation
will be more work in a larger setup.</p>
<p>We define the basin average ET (<code>et</code>) and the yields for
the crops in the HRUs 2, 3, and 4 (<code>yld_ag1</code>) to which the
crop rotation management <em>lrew_ag1</em> was assigned in the model
setup step as our model output variables. In this small setup these
three HRUs together are all HRUs with <em>lrew_ag1</em> in the model
setup. We will return the simulation outputs as annual values for the
time period 2006 to 2012.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">et_yld</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_swatplus.html">run_swatplus</a></span><span class="op">(</span>project_path <span class="op">=</span> <span class="va">path_plus</span>,</span>
<span>                       output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>et      <span class="op">=</span> <span class="fu"><a href="../reference/define_output.html">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'basin_wb'</span>, </span>
<span>                                                             variable <span class="op">=</span> <span class="st">'et'</span>, </span>
<span>                                                             unit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                     yld_ag1 <span class="op">=</span> <span class="fu"><a href="../reference/define_output.html">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'hru_pw'</span>,</span>
<span>                                                             variable <span class="op">=</span> <span class="st">'yield'</span>,</span>
<span>                                                             unit <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                       parameter <span class="op">=</span> <span class="va">par_et_yld</span>,</span>
<span>                       start_date <span class="op">=</span> <span class="va">cal_start</span>,</span>
<span>                       end_date <span class="op">=</span> <span class="va">cal_end</span>,</span>
<span>                       start_date_print <span class="op">=</span> <span class="va">cal_start_print</span>,</span>
<span>                       output_interval <span class="op">=</span> <span class="st">'y'</span>,</span>
<span>                       n_thread <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Building 4 threads in 'Define:/your/path/swatplus_rev60_demo/.model_run': </span></span>
<span><span class="co">#&gt;  Completed 4 threads in 0S                                                  </span></span>
<span><span class="co">#&gt; Performing 40 simulations on 4 cores: </span></span>
<span><span class="co">#&gt;  Completed 40 simulations in 1M 2S  </span></span></code></pre></div>
<div class="section level4">
<h4 id="model-evaluation-with-dotty-plots">Model evaluation with dotty plots<a class="anchor" aria-label="anchor" href="#model-evaluation-with-dotty-plots"></a>
</h4>
<p>Dotty plots are a very simple and effective way to evaluate parameter
ranges with respect to any scalar simulation output (e.g. average annual
sums) or performance metric (e.g. NSE, KGE, pbias, etc.). Below I
defined a function to do dotty plots. We will use this function for
model evaluation throughout the entire calibration example. It is
formulated in a very general way. Thus, you can use it in any of your
future work for model evaluation. The variable <code>par</code> must be
a <code>data.frame</code> or <code>tibble</code> with the parameter
values (which is the case for <code>run_swat*()</code> outputs).
<code>var</code> must be a vector of the scalar output variable that you
want to analyze with the dotty plots. This vector must have the same
length as the number of lines of the parameter table.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_dotty</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">par</span>, <span class="va">var</span>, <span class="va">y_label</span> <span class="op">=</span> <span class="st">'y'</span>, <span class="va">n_col</span> <span class="op">=</span> <span class="fl">3</span>, <span class="va">y_lim</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">dotty_tbl</span> <span class="op">&lt;-</span> <span class="va">par</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>var <span class="op">=</span> <span class="va">var</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">.</span>, cols <span class="op">=</span> <span class="op">-</span><span class="va">var</span>, names_to <span class="op">=</span> <span class="st">'parameter'</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">gg</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">dotty_tbl</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">value</span>, y <span class="op">=</span> <span class="va">var</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span> <span class="op">~</span> <span class="va">parameter</span>, ncol <span class="op">=</span> <span class="va">n_col</span>, scales <span class="op">=</span> <span class="st">"free_x"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Change of parameter value'</span>, y <span class="op">=</span> <span class="va">y_label</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">y_lim</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">gg</span> <span class="op">&lt;-</span> <span class="va">gg</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">ylim</a></span><span class="op">(</span><span class="va">y_lim</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">gg</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="evalualtion-of-average-annual-et">Evalualtion of average annual ET<a class="anchor" aria-label="anchor" href="#evalualtion-of-average-annual-et"></a>
</h4>
<p>In the simulation runs we returned annual values. To analyze average
annual values we have to calculate the mean of the annual values before
we can analyze them in a dotty plot.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">et_avann</span> <span class="op">&lt;-</span> <span class="va">et_yld</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">et</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">'run_'</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span></code></pre></div>
<p>We can now analyze the average annual ET values in dotty plots. To
put the simulated values into reference with “observed” values we add
the average annual ET that we estimated from discharge and precipitation
observations as a horizontal dashed line. <code>plot_dotty()</code>
returns a <code>ggplot</code> so we can simply add further ggplot layers
such as a <code><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline()</a></code> to plot a horizontal line to the
plot.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_dotty</span><span class="op">(</span>par <span class="op">=</span> <span class="va">et_yld</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span>, </span>
<span>           var <span class="op">=</span> <span class="va">et_avann</span>, </span>
<span>           y_label <span class="op">=</span> <span class="st">'av. annual ET'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">et_avann_est</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-17-1.png" width="672"></p>
<p>In the dotty plot we can see that larger values of <em>awc</em>,
<em>epco</em>, and <em>esco</em> will result in average annual ET
simulations that exceed the “observed” value. At their lower ends most
simulations would result in ET values which are lower than the
“observed” value. Constraining these parameters on their lower and upper
ends of their parameter ranges will therefore be necessary for further
simulations.</p>
</div>
<div class="section level4">
<h4 id="evalualtion-of-corn-yields">Evalualtion of corn yields<a class="anchor" aria-label="anchor" href="#evalualtion-of-corn-yields"></a>
</h4>
<p>Constraining the parameters <em>awc</em>, <em>epco</em>, and
<em>esco</em> can impact the simulation of plant growth and can reduce
the crop yields. Plant growth is however a central part in a SWAT model
and can affect many other processes (e.g. some water balance components
and nutrient cycles). Therefore, constraining parameter ranges should
not affect the plant growth and simulated yields. Typically a decrease
in ET can also decrease simulated yields and these two goals can be
conflicting in this calibration step.</p>
<p>First we will look into crop yields of single HRUs and individual
years. From the file <em>‘management.sch’</em> we can see that the
rotation of <em>lrew_ag1</em> is <em>pnut</em> &gt; <em>corn</em> &gt;
<em>cots</em> &gt; <em>cots</em>. So corn is planted and harvested in
the years 2004 and 2008 in these HRUs (where the year 2004 is in the
warm up period and was not printed). For the analysis with the dotty
plot we can extract now for example the yields for the year 2008 in the
HRU 3 (<code>.$yld_ag1_3</code>).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yld_corn_hru3</span> <span class="op">&lt;-</span> <span class="va">et_yld</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">yld_ag1_3</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2008</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The dotty plot shows that the most significant impact on the corn
crop yields is caused by <em>epco</em>. From the plot we can conclude
that <em>epco</em> should not be set lower than 0.4 or 0.5. Smaller are
also visible for <em>esco</em> and <em>awc</em> and we should also
constrain these two parameters on their lower boundaries.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_dotty</span><span class="op">(</span>par <span class="op">=</span> <span class="va">et_yld</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span>, </span>
<span>           var <span class="op">=</span> <span class="va">yld_corn_hru3</span>, </span>
<span>           y_label <span class="op">=</span> <span class="st">'corn yield, hru = 3'</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-19-1.png" width="672"></p>
<p>We can perform the same analysis for the mean corn yields where we
aggregate all corn yields for all HRUs and years in which corn was
planted. The code below is one approach to aggregate the simulated
yields.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yld_corn_ag1</span> <span class="op">&lt;-</span> <span class="va">et_yld</span><span class="op">$</span><span class="va">simulation</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'yld_ag1_'</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2008</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">'run_'</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p>The pattern of the aggregated yields is comparable to the dotty plot
above and we would draw similar conclusions from this plot.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_dotty</span><span class="op">(</span>par <span class="op">=</span> <span class="va">et_yld</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span>, </span>
<span>           var <span class="op">=</span> <span class="va">yld_corn_ag1</span>, </span>
<span>           y_label <span class="op">=</span> <span class="st">'av. corn yield'</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-21-1.png" width="672"></p>
</div>
<div class="section level4">
<h4 id="updating-parameter-boundaries-and-validating-et-and-yields">Updating parameter boundaries and validating ET and yields<a class="anchor" aria-label="anchor" href="#updating-parameter-boundaries-and-validating-et-and-yields"></a>
</h4>
<p>Based on the simulations of ET and corn yields we can now try to
constrain the boundaries of <em>awc</em>, <em>epco</em>, and
<em>esco</em>. The aim is to limit ET in a range that is not too far off
our observed value and not compromising the yield too much. Below you
can see my suggestion for updated parameter boundaries.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">'esco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>                    <span class="st">'epco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                    <span class="st">'awc.sol | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">par_et_yld</span> <span class="op">&lt;-</span> <span class="fu">sample_lhs</span><span class="op">(</span><span class="va">par_bound</span>, <span class="fl">20</span><span class="op">)</span></span></code></pre></div>
<p>We will validate the updated parameter boundaries to see if we meet
our aims for ET and yields. Again a small set of simulations might be
enough to get a picture of ET and yield.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">et_yld2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_swatplus.html">run_swatplus</a></span><span class="op">(</span>project_path <span class="op">=</span> <span class="va">path_plus</span>,</span>
<span>                        output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>et      <span class="op">=</span> <span class="fu"><a href="../reference/define_output.html">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'basin_wb'</span>, </span>
<span>                                                              variable <span class="op">=</span> <span class="st">'et'</span>, </span>
<span>                                                              unit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>                                      yld_ag1 <span class="op">=</span> <span class="fu"><a href="../reference/define_output.html">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'hru_pw'</span>,</span>
<span>                                                              variable <span class="op">=</span> <span class="st">'yield'</span>,</span>
<span>                                                              unit <span class="op">=</span> <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                        parameter <span class="op">=</span> <span class="va">par_et_yld</span>,</span>
<span>                        start_date <span class="op">=</span> <span class="va">cal_start</span>,</span>
<span>                        end_date <span class="op">=</span> <span class="va">cal_end</span>,</span>
<span>                        start_date_print <span class="op">=</span> <span class="va">cal_start_print</span>,</span>
<span>                        output_interval <span class="op">=</span> <span class="st">'y'</span>,</span>
<span>                        n_thread <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Building 4 threads in 'Define:/your/path/swatplus_rev60_demo/.model_run': </span></span>
<span><span class="co">#&gt;  Completed 4 threads in 0S                                                  </span></span>
<span><span class="co">#&gt; Performing 40 simulations on 4 cores: </span></span>
<span><span class="co">#&gt;  Completed 40 simulations in 28S  </span></span></code></pre></div>
<p>Repeating the dotty plot for ET with the updated parameter boundaries
shows that we overestimate ET now by about 20mm. Reducing the parameter
values further would however decrease the corn yields too much. Thus,
this is a compromise that we have to accept.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">et_avann</span> <span class="op">&lt;-</span> <span class="va">et_yld2</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">et</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">'run_'</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span></span>
<span><span class="fu">plot_dotty</span><span class="op">(</span>par <span class="op">=</span> <span class="va">et_yld2</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span>, </span>
<span>           var <span class="op">=</span> <span class="va">et_avann</span>, </span>
<span>           y_label <span class="op">=</span> <span class="st">'av. annual ET'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="va">et_avann_est</span>, linetype <span class="op">=</span> <span class="st">'dashed'</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-25-1.png" width="672"></p>
<p>Plotting the average corn yields we can see that the yields were
decreased a bit. Yet, the simulated values are with 8.2 tons still
within a plausible range.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">yld_corn_ag1</span> <span class="op">&lt;-</span> <span class="va">et_yld2</span><span class="op">$</span><span class="va">simulation</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">'yld_ag1_'</span>, <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">)</span><span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">.</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="fu"><a href="https://lubridate.tidyverse.org/reference/year.html" class="external-link">year</a></span><span class="op">(</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2008</span>, <span class="fl">2012</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span>.cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html" class="external-link">starts_with</a></span><span class="op">(</span><span class="st">'run_'</span><span class="op">)</span>, .fns <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_dotty</span><span class="op">(</span>par <span class="op">=</span> <span class="va">et_yld2</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span>, </span>
<span>           var <span class="op">=</span> <span class="va">yld_corn_ag1</span>, </span>
<span>           y_label <span class="op">=</span> <span class="st">'av. corn yield'</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-26-1.png" width="672"></p>
</div>
</div>
<div class="section level3">
<h3 id="calibration-of-discharge">Calibration of discharge<a class="anchor" aria-label="anchor" href="#calibration-of-discharge"></a>
</h3>
<div class="section level4">
<h4 id="parameter-definition-and-simulation-runs">Parameter definition and simulation runs<a class="anchor" aria-label="anchor" href="#parameter-definition-and-simulation-runs"></a>
</h4>
<p>The calibration of daily discharge that we will perform for our demo
catchment is a very basic one. In an actual case study I strongly
recommend to perform a more comprehensive analysis of your catchment
than we will do now. This example should just demonstrate how you can
perform simulations, evaluate the simulations with model performance
metrics and select model setups that represent the discharge well. A
more comprehensive analysis could for example include the analysis of
several water balance components, the separation of the hydrograph into
fast runoff, lateral and base flow, a separation of the parameters into
functional groups for calibration, or conditioning parameters into
separate zones.</p>
<p>In this example, however, we will simultaneously change the values of
10 parameters which are relevant for the simulation of discharge. Our
parameter set includes the parameters <em>‘esco’</em>, <em>‘epco’</em>,
and <em>‘awc’</em> which we constrained already in the previous step.
Additionally we will include <em>‘cn2’</em>, <em>‘cn3_swf’</em>,
<em>lat_ttime</em>, <em>latq_co</em>, <em>k</em>, <em>‘perco’</em>, and
<em>alpha</em>. Unless there is no experience with plausible parameter
ranges I would start with very wide ranges in which to vary the
parameter values. You may ask why for some parameters we intend to
replace the initial parameter valyes by new values (<code>absval</code>,
e.g. <em>‘esco’</em>), while the initial values of other parameters are
changed by a certain fraction (<code>relchg</code>, e.g. <em>‘awc’</em>)
or an absolute value (<code>abschg</code>, e.g. <em>‘cn2’</em>, or
<em>‘perco’</em>). One reason for <code>relchg</code> and
<code>abschg</code> can be if a parameter does have a spatial
distribution (different initial values for different HRUs) which is the
case for <em>‘cn2’</em>, <em>‘cn3_swf’</em>, <em>‘awc’</em>, and
<em>‘perco’</em> in this model setup. <em>‘esco’</em> and
<em>‘epco’</em> do have global default values and we do not have any
good reason to assign different values to different spatial units here.
Therefore the type of change we use is <code>absval</code>.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_bound</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span><span class="st">'esco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.15</span>, <span class="fl">0.3</span><span class="op">)</span>,</span>
<span>                    <span class="st">'epco.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                    <span class="st">'awc.sol | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.1</span>, <span class="fl">0.0</span><span class="op">)</span>,</span>
<span>                    <span class="st">'cn2.hru | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">10</span>, <span class="fl">10</span><span class="op">)</span>,</span>
<span>                    <span class="st">'cn3_swf.hru | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                    <span class="st">'lat_ttime.hru | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">20</span><span class="op">)</span>,</span>
<span>                    <span class="st">'latq_co.hru | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                    <span class="st">'k.sol | change = relchg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                    <span class="st">'perco.hru | change = abschg'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">0.5</span>, <span class="fl">0.5</span><span class="op">)</span>,</span>
<span>                    <span class="st">'alpha.aqu | change = absval'</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.01</span>, <span class="fl">0.9</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For the discharge simulations in the model calibration we sample 500
combinations of the 10 selected parameters within the defined boundaries
with LHS sampling.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_cal</span> <span class="op">&lt;-</span> <span class="fu">sample_lhs</span><span class="op">(</span><span class="va">par_bound</span>, <span class="fl">500</span><span class="op">)</span></span></code></pre></div>
<p>In this small example we will now only focus on the discharge of the
main catchment outlet. Therefore, the only variable we will simulate for
the 500 parameter combinations <code>par_cal</code> is the daily channel
discharge. The simulation period we defined already at the beginning of
this article and saved the dates for the simulation period in the
variables <code>cal_start</code>, <code>cal_end</code>, and
<code>cal_start_print</code>.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qsim_cal</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_swatplus.html">run_swatplus</a></span><span class="op">(</span>project_path <span class="op">=</span> <span class="va">path_plus</span>,</span>
<span>                         output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fu"><a href="../reference/define_output.html">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'channel_sd'</span>, </span>
<span>                                                         variable <span class="op">=</span> <span class="st">'flo_out'</span>, </span>
<span>                                                         unit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         parameter <span class="op">=</span> <span class="va">par_cal</span>,</span>
<span>                         start_date <span class="op">=</span> <span class="va">cal_start</span>,</span>
<span>                         end_date <span class="op">=</span> <span class="va">cal_end</span>,</span>
<span>                         start_date_print <span class="op">=</span> <span class="va">cal_start_print</span>,</span>
<span>                         n_thread <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Building 4 threads in 'Define:/your/path/swatplus_rev60_demo/.model_run': </span></span>
<span><span class="co">#&gt;  Completed 4 threads in 0S                                                  </span></span>
<span><span class="co">#&gt; Performing 500 simulations on 4 cores: </span></span>
<span><span class="co">#&gt;  Completed 500 simulations in 12M 40S   </span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="evaluation-of-model-runs">Evaluation of model runs<a class="anchor" aria-label="anchor" href="#evaluation-of-model-runs"></a>
</h4>
<p>We could use many different approaches and performance criteria to
assess the performed model simulations and for an actual case study I
would strongly recommend to do so. For our simple example we will use
two performance metrics and apply them to our daily discharge
simulations to compare the simulations with discharge observations at
the main outlet. We will use the Kling-Gupta-Efficiency (KGE, <span class="citation">Gupta et al. (<a href="#ref-Gupta2009">2009</a>)</span>) and the percent bias (pbias,
<span class="citation">Gupta et al. (<a href="#ref-Gupta1999">1999</a>)</span>) to evaluate the model
simulations and to identify acceptable parameter combinations.</p>
<p>The code below can be used in many other situations where you want to
evaluate multiple model simulations from <code>run_swat*()</code>
simultaions with a performance metric that returns a single value. You
can again use this as a recipe for your future analysis. We use
<code><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl()</a></code> to apply the function <code><a href="https://rdrr.io/pkg/hydroGOF/man/KGE.html" class="external-link">KGE()</a></code> to all
simulated time series of the discharge to calculate the <code>KGE</code>
values for all parameter combinations.</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kge_cal</span> <span class="op">&lt;-</span> <span class="va">qsim_cal</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">q</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">qobs_cal</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/hydroGOF/man/KGE.html" class="external-link">KGE</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">qobs_cal</span><span class="op">$</span><span class="va">discharge</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>With <code>plot_dotty()</code> we again generate dotty plots to
analyze the parameter ranges of all parameters.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_dotty</span><span class="op">(</span>par <span class="op">=</span> <span class="va">qsim_cal</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span>, </span>
<span>           y_label <span class="op">=</span> <span class="st">'KGE'</span>, var <span class="op">=</span> <span class="va">kge_cal</span>, n_col <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-32-1.png" width="1056"></p>
<p>We can see that the KGE values of all simulations are already in a
range between 0 and 0.8. This means that only based on the <em>KGE</em>
we can already find model simulations that perform well in simulating
the observed discharge. Some of the tested parameters also show clear
patterns. The most significant patterns can be found for <em>perco</em>.
<em>perco</em> shows a steep increase in <em>KGE </em>if we increase all
<em>perco</em> values by increments of 0.05 to 0.50. Decreasing
<em>cn2</em> and <em>cn3_swf</em> also can slightly improve the model
performance when we closely look at the outer boundary of the parameter
response surface for those two parameters. <em>alpha</em> improves the
model performance in a range between 0.2 and 0.5.</p>
<p>We can do the same analysis with the <em>pbias</em> and plot dotty
plots for the parameters. Overall we can see now that the majority of
model simulations result in a negative <em>pbias</em> and only a few
simulations reach values close to 0. This is very likely due to our
limitations we had in constraining ET without reducing crop yields too
much. <em>perco</em> again shows a similar pattern by improving the
<em>pbias</em> with increasing the initial values of <em>perco</em>.
Also a reduction of <em>cn3_swf</em> and the improvement of
<em>pbias</em> is in line with the results for <em>KGE</em>. An increase
of <em>cn2</em> however would now result in a decrease of <em>pbias</em>
which is in conflict with the results for <em>KGE</em>. Thus, an
improvement of <em>KGE</em> could only be achieved at a cost for
<em>pbias</em>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pbias_cal</span> <span class="op">&lt;-</span> <span class="va">qsim_cal</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">q</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">qobs_cal</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/hydroGOF/man/pbias.html" class="external-link">pbias</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">qobs_cal</span><span class="op">$</span><span class="va">discharge</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_dotty</span><span class="op">(</span>par <span class="op">=</span> <span class="va">qsim_cal</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span>, </span>
<span>           y_label <span class="op">=</span> <span class="st">'KGE'</span>, var <span class="op">=</span> <span class="va">pbias_cal</span>, n_col <span class="op">=</span> <span class="fl">5</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-33-1.png" width="1056"></p>
</div>
<div class="section level4">
<h4 id="selecting-acceptable-parameter-combinations">Selecting acceptable parameter combinations<a class="anchor" aria-label="anchor" href="#selecting-acceptable-parameter-combinations"></a>
</h4>
<p>We want to select parameter sets which perform well with respect to
<em>KGE</em> and which at the same time do not result in absolute
<em>pbias</em> values which are too large. In the SWAT Literature
certain recommendations are very often used to define a model
performance as acceptable. I would strongly recommend not to refer to
such globally defined thresholds! In my opinion this is bad practice, as
the potential to reach a certain value of model performance can also
depend of other factors such as the variability and seasonality of the
observed runoff. In some settings it can be easy to achieve high values
in certain performance metrics, while in other settings it may be a
challenge. Thus, the calculated values of performance metrics may help
you in selecting simulations that performed better than others in your
catchment, but they should not be used to justify a model setup as “good
to use”.</p>
<p>In the dotty plots above you can see that in the setting of the demo
catchment it is easy to achieve high <em>KGE</em> values, while it is
more difficult to simulate enough discharge (negative <em>pbias</em>).
To select a few simulations that we want to further investigate I
defined thresholds for absolute <em>pbias</em> &lt; 15% and for
<em>KGE</em> &gt; 0.75.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">run_sel</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">pbias_cal</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">15</span> <span class="op">&amp;</span> <span class="va">kge_cal</span> <span class="op">&gt;</span> <span class="fl">0.75</span><span class="op">)</span></span></code></pre></div>
<p>We will save the evaluation results for the selected parameter
combinations in a table. This can be helpful for reporting the results
in tabular form but also for plotting the model performance. It can be a
challenge to identify one or a few best model simulations, particularly
when you use several metrics to evaluate your simulations that
additionally can vary in different ranges. In such cases you can for
example just rank the model performances and calculate for example the
sum of ranks. In this example I simply ranked the <em>KGE</em> values in
a descending order and ranked the absolute <em>pbias</em> values. In a
final step I ranked the sum of ranks to sort the model performances.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cal_eval_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>id <span class="op">=</span> <span class="va">run_sel</span>,</span>
<span>                       run <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">run_sel</span><span class="op">)</span>, </span>
<span>                       kge <span class="op">=</span> <span class="va">kge_cal</span><span class="op">[</span><span class="va">run_sel</span><span class="op">]</span>,</span>
<span>                       pbias <span class="op">=</span> <span class="va">pbias_cal</span><span class="op">[</span><span class="va">run_sel</span><span class="op">]</span>,</span>
<span>                       rank <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="op">-</span><span class="va">kge</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/rank.html" class="external-link">rank</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">pbias</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">rank</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cal_eval_tbl</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 18 × 5</span></span></span>
<span><span class="co">#&gt;       id run       kge pbias  rank</span></span>
<span><span class="co">#&gt;    <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 1</span>   148 run_148 0.794  -<span style="color: #BB0000;">9.6</span>   1  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 2</span>     4 run_004 0.768  -<span style="color: #BB0000;">9.5</span>   3.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 3</span>   137 run_137 0.766  -<span style="color: #BB0000;">8.8</span>   3.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 4</span>   253 run_253 0.767  -<span style="color: #BB0000;">9.2</span>   3.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 5</span>   436 run_436 0.763  -<span style="color: #BB0000;">3.7</span>   3.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 6</span>   226 run_226 0.784 -<span style="color: #BB0000;">12.2</span>   6.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 7</span>   464 run_464 0.780 -<span style="color: #BB0000;">11.7</span>   6.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 8</span>   244 run_244 0.774 -<span style="color: #BB0000;">12.3</span>   8  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;"> 9</span>   325 run_325 0.772 -<span style="color: #BB0000;">12.4</span>   9  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">10</span>   157 run_157 0.763 -<span style="color: #BB0000;">11.5</span>  10  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">11</span>   348 run_348 0.751 -<span style="color: #BB0000;">10.9</span>  11  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">12</span>   459 run_459 0.762 -<span style="color: #BB0000;">13.1</span>  12  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">13</span>   113 run_113 0.753 -<span style="color: #BB0000;">12.9</span>  13  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">14</span>   300 run_300 0.752 -<span style="color: #BB0000;">13</span>    14  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">15</span>   269 run_269 0.755 -<span style="color: #BB0000;">13.5</span>  15.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">16</span>   415 run_415 0.756 -<span style="color: #BB0000;">13.9</span>  15.5</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">17</span>   406 run_406 0.750 -<span style="color: #BB0000;">13.3</span>  17  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">18</span>    67 run_067 0.751 -<span style="color: #BB0000;">14.9</span>  18</span></span></code></pre></div>
<p>For reporting it may be interesting to have a table with your “best”
simulation and the ranges of model performances for your acceptable
model ensemble. Below we generate such a summary. Be careful with the
“best” performance. This works in this case, as we already sorted the
model performances based on their ranks and the best one is the top one
in the table.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cal_summary</span> <span class="op">&lt;-</span> <span class="va">cal_eval_tbl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">kge</span>, <span class="va">pbias</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">.</span>, cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/everything.html" class="external-link">everything</a></span><span class="op">(</span><span class="op">)</span>,names_to <span class="op">=</span> <span class="st">'metric'</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">metric</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarise</a></span><span class="op">(</span><span class="va">.</span>, best <span class="op">=</span> <span class="va">value</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, min <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, max <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">cal_summary</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 4</span></span></span>
<span><span class="co">#&gt;   metric   best     min    max</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> kge     0.794   0.750  0.794</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> pbias  -<span style="color: #BB0000;">9.6</span>   -<span style="color: #BB0000;">14.9</span>   -<span style="color: #BB0000;">3.7</span></span></span></code></pre></div>
<p>As mentioned above it is bad practice to solely rely on certain
values of performance metrics to define a model as well performing. The
least thing we should always do is to plot the simulated discharge
against the observed one to identify the strengths and the weaknesses of
a calibration which should be improved in a next iteration of the model
calibration.</p>
<p>For the evaluation of the simulated discharge time series we will
summarize the selected simulations and calculate upper and lower
boundaries of the daily model simulations. Additionally we select the
simulations of the “best” simulation for plotting.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qcal_sel</span> <span class="op">&lt;-</span> <span class="va">qsim_cal</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">q</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">date</span>, <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html" class="external-link">all_of</a></span><span class="op">(</span><span class="va">cal_eval_tbl</span><span class="op">$</span><span class="va">run</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>best <span class="op">=</span> <span class="va">.</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>         qmax <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">max</span><span class="op">)</span>,</span>
<span>         qmin <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">min</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">best</span>, <span class="va">qmin</span>,<span class="va">qmax</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">qsim_cal</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">q</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span></code></pre></div>
<p>The plot below now shows the simulated ranges of the discharge as a
grey area and the best run as a grey line. The observed discharge is
plotted as a black line. We can clearly see that although the
performance metrics already indicate a “good” model performance the
simulations have quite significant weaknesses in their representation of
the runoff processes. While the variability in the simulated discharge
may already be ok, the simulated recession of the runoff peaks is rather
poor and must be improved. At this point it would be strongly advised to
continue with further iterations in the model calibration. It would
require to repeat several of the steps above, while updating parameter
boundaries and introducing/removing parameters in the parameter set. For
this small example we will however stop with the calibration at this
point.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">qcal_sel</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, ymin <span class="op">=</span> <span class="va">qmin</span>, ymax <span class="op">=</span> <span class="va">qmax</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">'grey30'</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">qmin</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'grey30'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">qmax</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'grey30'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">best</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'tomato3'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">qobs_cal</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">discharge</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span> <span class="op">(</span><span class="va">Discharge</span><span class="op">~</span><span class="op">(</span><span class="va">m</span><span class="op">^</span><span class="fl">3</span><span class="op">~</span><span class="va">s</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">1</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>, x <span class="op">=</span> <span class="st">'Date (year)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-38-1.png" width="1056"></p>
</div>
</div>
<div class="section level3">
<h3 id="validation-of-selected-parameter-combinations">Validation of selected parameter combinations<a class="anchor" aria-label="anchor" href="#validation-of-selected-parameter-combinations"></a>
</h3>
<p>A common procedure in hydrological modelling is to assess the model
performance of model setups which performed well in the calibration
period with observation data that was not used in model calibration. In
this small example we calibrated the model setup in the time period 2006
to 2009 and will use the selected model to validate their model
performance in the time period 2010 t0 2012.</p>
<p>For the simulations of discharge in the validation period we extract
the parameter sets that we identified to perform well in the model
calibration and write them into a table that we can use in the new SWAT
simulations. Be aware here that the parameter table
<code>.$parameter$values</code> uses the short names of the parameters.
For the parameter definition in the SWAT simulations we again need the
long names that also define e.g. the type of change. We can set the
names by extracting the parameters’ full names from
<code>.$parameter$definition$full_name</code>.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">par_val</span> <span class="op">&lt;-</span> <span class="va">qsim_cal</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">values</span><span class="op">[</span><span class="va">cal_eval_tbl</span><span class="op">$</span><span class="va">id</span>,<span class="op">]</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rlang.r-lib.org/reference/set_names.html" class="external-link">set_names</a></span><span class="op">(</span><span class="va">qsim_cal</span><span class="op">$</span><span class="va">parameter</span><span class="op">$</span><span class="va">definition</span><span class="op">$</span><span class="va">full_name</span><span class="op">)</span></span></code></pre></div>
<p>We will run the simulations with the selected parameter combinations
for the validation period which we already defined at the beginning of
this small calibration example.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span></span>
<span><span class="va">qsim_val</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_swatplus.html">run_swatplus</a></span><span class="op">(</span>project_path <span class="op">=</span> <span class="va">path_plus</span>,</span>
<span>                         output <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>q <span class="op">=</span> <span class="fu"><a href="../reference/define_output.html">define_output</a></span><span class="op">(</span>file <span class="op">=</span> <span class="st">'channel_sd'</span>, </span>
<span>                                                         variable <span class="op">=</span> <span class="st">'flo_out'</span>, </span>
<span>                                                         unit <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                         parameter <span class="op">=</span> <span class="va">par_val</span>,</span>
<span>                         start_date <span class="op">=</span> <span class="va">val_start</span>,</span>
<span>                         end_date <span class="op">=</span> <span class="va">val_end</span>,</span>
<span>                         start_date_print <span class="op">=</span> <span class="va">val_start_print</span>,</span>
<span>                         n_thread <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co">#&gt; Building 4 threads in 'Define:/your/path/swatplus_rev60_demo/.model_run': </span></span>
<span><span class="co">#&gt;  Completed 4 threads in 0S                                                  </span></span>
<span><span class="co">#&gt; Performing 18 simulations on 4 cores: </span></span>
<span><span class="co">#&gt;  Completed 18 simulations in 23S  </span></span></code></pre></div>
<p>We will again use the <em>KGE</em> and the <em>pbias</em> to assess
the model performance in the validation period. For their calculation we
can again use the recipe from above and just replace the simulation
outputs.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">kge_val</span> <span class="op">&lt;-</span> <span class="va">qsim_val</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">q</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">qobs_val</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/hydroGOF/man/KGE.html" class="external-link">KGE</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">qobs_val</span><span class="op">$</span><span class="va">discharge</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pbias_val</span> <span class="op">&lt;-</span> <span class="va">qsim_val</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">q</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">date</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">qobs_val</span><span class="op">$</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html" class="external-link">map_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/pkg/hydroGOF/man/pbias.html" class="external-link">pbias</a></span><span class="op">(</span><span class="va">.x</span>, <span class="va">qobs_val</span><span class="op">$</span><span class="va">discharge</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For a final comparison we will generate a table with the calibration
and validation results. The table with the validation results will
include a column with the simulation period indicating that these are
the results from the validation period and the values for <em>KGE</em>
and <em>pbias</em>. We rearrange the table for the calibration period
<code>cal_eval_tbl</code> that it is organized in the same way as the
validation results and we bind those tablse together.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">val_eval_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span>period <span class="op">=</span> <span class="st">'validation'</span>,</span>
<span>                       kge <span class="op">=</span> <span class="va">kge_val</span>,</span>
<span>                       pbias <span class="op">=</span> <span class="va">pbias_val</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eval_tbl</span> <span class="op">&lt;-</span> <span class="va">cal_eval_tbl</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">kge</span>, <span class="va">pbias</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>period <span class="op">=</span> <span class="st">'calibration'</span>, .before <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html" class="external-link">bind_rows</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">val_eval_tbl</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html" class="external-link">pivot_longer</a></span><span class="op">(</span><span class="va">.</span>, cols <span class="op">=</span> <span class="op">-</span> <span class="va">period</span><span class="op">)</span></span></code></pre></div>
<p>We can now for example use these data to plot a comparison of the
model performance in the calibration and validation periods. We plot a
simple boxplot together with the individual data points for the used
parameter combinations. We can see from the plot that the model
performance in the validation period is quite comparable to the one in
the calibration period. Thus, we can assume that we did not overfit the
model to the calibration data and the model is also capable of
simulating time periods that were not used in the model calibration.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">eval_tbl</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_boxplot.html" class="external-link">geom_boxplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_jitter.html" class="external-link">geom_jitter</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">period</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span>, <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">'Simulation period'</span>, y <span class="op">=</span> <span class="st">'Performance metric value'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="va">.</span><span class="op">~</span><span class="va">name</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-44-1.png" width="480"></p>
<p>Finally we will also have a look at the daily discharge simulations
in the validation period compared to the observation data. For the
aggregation of the simulated time series we can again use the code that
we already used for the simulations in the calibration period. Again the
selection of the best run with <code>best = .[[1]]</code> only works in
this case because we arranged the parameter combinations in a way that
the first parameter set is the one that resulted in the best simulation
of the calibration period.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">qval_sel</span> <span class="op">&lt;-</span> <span class="va">qsim_val</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">q</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>best <span class="op">=</span> <span class="va">.</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>,</span>
<span>         qmax <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">max</span><span class="op">)</span>,</span>
<span>         qmin <span class="op">=</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pmap.html" class="external-link">pmap_dbl</a></span><span class="op">(</span><span class="va">.</span>, <span class="va">min</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="va">best</span>, <span class="va">qmin</span>,<span class="va">qmax</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>date <span class="op">=</span> <span class="va">qsim_val</span><span class="op">$</span><span class="va">simulation</span><span class="op">$</span><span class="va">q</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span></code></pre></div>
<p>We also use the same code for plotting the validation time series. We
only have to replace the calibration data sets with the ones of the
validation period.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">qval_sel</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, ymin <span class="op">=</span> <span class="va">qmin</span>, ymax <span class="op">=</span> <span class="va">qmax</span><span class="op">)</span>, fill <span class="op">=</span> <span class="st">'grey30'</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">qmin</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'grey30'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">qmax</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'grey30'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">best</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'tomato3'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">qobs_val</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">date</span>, y <span class="op">=</span> <span class="va">discharge</span><span class="op">)</span>, col <span class="op">=</span> <span class="st">'black'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span> <span class="op">(</span><span class="va">Discharge</span><span class="op">~</span><span class="op">(</span><span class="va">m</span><span class="op">^</span><span class="fl">3</span><span class="op">~</span><span class="va">s</span><span class="op">^</span><span class="op">{</span><span class="op">-</span><span class="fl">1</span><span class="op">}</span><span class="op">)</span><span class="op">)</span>, x <span class="op">=</span> <span class="st">'Date (year)'</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<p><img src="par_sampl_calib_files/figure-html/unnamed-chunk-46-1.png" width="1056"></p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body">
<div id="ref-Carnell2019" class="csl-entry">
Carnell, R.: Lhs: Latin hypercube samples. [online] Available from: <a href="https://CRAN.R-project.org/package=lhs" class="external-link">https://CRAN.R-project.org/package=lhs</a>
(Accessed 5 March 2019), 2019.
</div>
<div id="ref-Gupta1999" class="csl-entry">
Gupta, H. V., Sorooshian, S. and Yapo, P. O.: <span class="nocase">Status of Automatic Calibration for Hydrologic Models:
Comparison with Multilevel Expert Calibration</span>, Journal of
Hydrologic Engineering, 4(2), 135–143, doi:<a href="https://doi.org/10.1061/(ASCE)1084-0699(1999)4:2(135)" class="external-link">10.1061/(ASCE)1084-0699(1999)4:2(135)</a>,
1999.
</div>
<div id="ref-Gupta2009" class="csl-entry">
Gupta, H. V., Kling, H., Yilmaz, K. K. and Martinez, G. F.: <span class="nocase">Decomposition of the mean squared error and NSE
performance criteria: Implications for improving hydrological
modelling</span>, Journal of Hydrology, 377(1-2), 80–91, doi:<a href="https://doi.org/10.1016/j.jhydrol.2009.08.003" class="external-link">10.1016/j.jhydrol.2009.08.003</a>,
2009.
</div>
<div id="ref-Henry2019" class="csl-entry">
Henry, L. and Wickham, H.: Purrr: Functional programming tools. [online]
Available from: <a href="https://CRAN.R-project.org/package=purrr" class="external-link">https://CRAN.R-project.org/package=purrr</a>
(Accessed 3 May 2019), 2019.
</div>
<div id="ref-Mueller2019" class="csl-entry">
Müller, K. and Wickham, H.: Tibble: Simple data frames. [online]
Available from: <a href="https://CRAN.R-project.org/package=tibble" class="external-link">https://CRAN.R-project.org/package=tibble</a>
(Accessed 5 March 2019), 2019.
</div>
<div id="ref-Rcore2019" class="csl-entry">
R Core Team: <span class="nocase">R: A language and environment for
statistical computing.</span>, [online] Available from: <a href="https://www.r-project.org/" class="external-link">https://www.r-project.org/</a>
(Accessed 5 March 2019), 2019.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by <a href="https://github.com/chrisschuerz" class="external-link">Christoph Schuerz</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
