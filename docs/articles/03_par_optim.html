<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>03 - Parameter optimization • SWATplusR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="03 - Parameter optimization">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SWATplusR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.7</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/SWATplusR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/01_par_sensitivity.html">01 - Parameter sensitivity analysis</a>
    </li>
    <li>
      <a href="../articles/02_par_sampl_calib.html">02 - Parameter sampling and model calibration</a>
    </li>
    <li>
      <a href="../articles/03_par_optim.html">03 - Parameter optimization</a>
    </li>
    <li>
      <a href="../articles/04_vis_example.html">04 - Visualization of simulation results</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/chrisschuerz/SWATplusR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>03 - Parameter optimization</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/chrisschuerz/SWATplusR/blob/master/vignettes/03_par_optim.Rmd"><code>vignettes/03_par_optim.Rmd</code></a></small>
      <div class="hidden name"><code>03_par_optim.Rmd</code></div>

    </div>

    
    
<div id="r-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#r-packages" class="anchor"></a>R packages</h2>
<p>There are many optimization routines available in R. The base R package <code>stats</code> <span class="citation">(R Core Team, <a href="#ref-Rcore2019">2019</a>)</span> provides the function <code><a href="https://www.rdocumentation.org/packages/stats/topics/optim">optim()</a></code> that offers several standard methods for model parameter optimization. The <code>hydromad</code> <span class="citation">(Andrews and Guillaume, <a href="#ref-Andrews2018">2018</a>)</span> package provides a complete environment for hydrological modeling in R. It also offers several optimization algorithms that are standard methods in hydrological modeling, such as the Shuffled Complex Evolution algorithm <span class="citation">(SCE; Duan et al., <a href="#ref-Duan1993">1993</a>)</span>, or the Dynamically Dimensioned Search algorithm <span class="citation">(DDS; Tolson and Shoemaker, <a href="#ref-Tolson2007">2007</a>)</span>. A flexible integration of the DDS algorithm for R can also be found on the following <a href="https://github.com/bdb67/Dynamically-Dimensioned-Search">github repository</a> <span class="citation">(Bass, <a href="#ref-Bass2019">2014</a>)</span>. Multiple goodness-of-fit functions are available from literature to evaluate simulated time series with observed time series of that variable. The <code>hydroGOF</code> package <span class="citation">(Mauricio Zambrano-Bigiarini, <a href="#ref-MZB2017">2017</a>)</span> summarizes frequently used functions for the evaluation of time series of hydrological variables.</p>
<div id="package-installation" class="section level3">
<h3 class="hasAnchor">
<a href="#package-installation" class="anchor"></a>Package installation</h3>
<p>If you do not have installed any of the required R package, follow the instructions for the respective R package.</p>
<p>The <code>hydromad</code> package can be installed following the instructions on the <a href="http://hydromad.catchment.org/#installation">hydromad website</a>.</p>
<p>The other R packages are available from CRAN and can be installed with the following commands:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"hydroGOF"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"dplyr"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"lubridate"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"tidyr"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"ggplot2"</span>)</code></pre></div>
</div>
<div id="loading-r-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#loading-r-packages" class="anchor"></a>Loading R packages</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(SWATplusR)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(hydromad)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(hydroGOF)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lubridate)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</code></pre></div>
</div>
</div>
<div id="loading-demo-data" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-demo-data" class="anchor"></a>Loading demo data</h2>
<p>The optimization example uses the SWAT+ demo project available from <code>SWATplusR</code>. The demo project is a simple model setup of a head watershed of the Little River Experimental Watershed <span class="citation">(LREW; Bosch et al., <a href="#ref-Bosch2007">2007</a>)</span>. You can load the to your hard drive as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The path where the SWAT demo project will be written</span>
demo_path &lt;-<span class="st"> "Define:/your/path"</span>

<span class="co"># Loading the SWAT+ demo project on your hard drive</span>
path_plus &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_demo.html">load_demo</a></span>(<span class="dt">dataset =</span> <span class="st">"project"</span>,
                       <span class="dt">version =</span> <span class="st">"plus"</span>,
                       <span class="dt">path =</span> demo_path,
                       <span class="dt">revision =</span> <span class="dv">57</span>)</code></pre></div>
<p><code>SWATplusR</code> also provides observation data of daily discharge records at the main outlet of the demo for the time period 1968-01-01 until 2012-12-31. We will use the observation data to evaluate the model in each optimization step. The model will be evaluated for the time period 2003-01-01 to 2012-12-31. Therefore, we load the demo data and limit it to this time period:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q_obs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_demo.html">load_demo</a></span>(<span class="dt">dataset =</span> <span class="st">"observation"</span>)

q_obs &lt;-<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(q_obs, date <span class="op">&gt;=</span><span class="st"> </span><span class="kw"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"2003-01-01"</span>),
                       date <span class="op">&lt;=</span><span class="st"> </span><span class="kw"><a href="http://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span>(<span class="st">"2012-12-31"</span>))</code></pre></div>
</div>
<div id="definition-of-the-function-to-optimize" class="section level2">
<h2 class="hasAnchor">
<a href="#definition-of-the-function-to-optimize" class="anchor"></a>Definition of the function to optimize</h2>
<p>Most optimizers require a function as an input argument that uses a parameter set as input and returns a scalar value as a result. To use the <code><a href="../reference/run_swatplus.html">run_swatplus()</a></code> function in the optimization we wrap a function around the SWAT model execution that will be implemented in the optimizer to search the optimum parameter set that minimizes the return value (minimization is usually the default option in optimizers). An important side note for running SWAT+, the discharge is written in <span class="math inline">\(ha \cdot m \cdot day{-1}\)</span> (in our case it is day!). A conversion to <span class="math inline">\(m^{3} \cdot s^{-1}\)</span> requires to devide by <span class="math inline">\(8.64\)</span>. Below you see how you can implement the model execution into a function that can be optimized:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">swat_model &lt;-<span class="st"> </span><span class="cf">function</span>(par) {
  <span class="kw"><a href="../reference/run_swatplus.html">run_swatplus</a></span>(<span class="dt">project_path =</span> path_plus,
               <span class="dt">output =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">q_sim =</span> <span class="kw"><a href="../reference/define_output.html">define_output</a></span>(<span class="dt">file =</span> <span class="st">"channel"</span>,
                                     <span class="dt">variable =</span> <span class="st">"flo_out"</span>,
                                     <span class="dt">unit =</span> <span class="dv">1</span>)),
               <span class="dt">parameter =</span> par,
               <span class="dt">start_date =</span> <span class="st">"2000-01-01"</span>,
               <span class="dt">end_date =</span> <span class="st">"2012-12-31"</span>,
               <span class="dt">years_skip =</span> <span class="dv">3</span>,
               <span class="dt">quiet =</span> <span class="ot">TRUE</span>)
}

swat_optim &lt;-<span class="st"> </span><span class="cf">function</span>(par, obs) {
  q_sim &lt;-<span class="st"> </span><span class="kw">swat_model</span>(par)
  nse_q &lt;-<span class="st"> </span><span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/hydroGOF/topics/NSE">NSE</a></span>(q_sim<span class="op">$</span>simulation<span class="op">$</span>q_sim<span class="op">/</span><span class="fl">8.64</span>, obs)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(nse_q)
  }</code></pre></div>
<p>We defined a function that has one input argument <code>par</code> that is the named parameter vector that will be passed to <code><a href="../reference/run_swatplus.html">run_swatplus()</a></code>. The simulation will return the discharge at the main outlet (<code>unit = 1</code>) for the time period 2003-01-01 to 2012-12-31 (considering the <code>years_skip = 3</code> as warm up period). In this case we set the function to be <code>quiet = TRUE</code>. In a next step the function uses the observed discharge values from <code>q_obs$discharge</code> for the same period and evaluate the simulated discharges using the Nash Sutcliffe Efficiency criterion <span class="citation">(Nash and Sutcliffe, <a href="#ref-Nash1970">1970</a>)</span> that is available with the function <code><a href="https://www.rdocumentation.org/packages/hydroGOF/topics/NSE">NSE()</a></code> from the package <code>hydroGOF</code> that is then returned as a single value. You can see that we implemented the negative NSE as we will minimize with <code><a href="https://www.rdocumentation.org/packages/stats/topics/optim">optim()</a></code></p>
</div>
<div id="parameter-optimization-with-optim" class="section level2">
<h2 class="hasAnchor">
<a href="#parameter-optimization-with-optim" class="anchor"></a>Parameter optimization with <code>optim</code>
</h2>
<p>The <code><a href="https://www.rdocumentation.org/packages/stats/topics/optim">optim()</a></code> function provides several optimization routines (see the ‘Details’ section in the R help file). Most of the offered algorithms, however, do not provide the option to define parameter boundaries. Though, constraining SWAT model parameters is essential as these are bound in the model. The <code>method = 'L-BFGS-B'</code> implements a ‘quasi-Newton’ method according to <span class="citation">Byrd et al. (<a href="#ref-Byrd1995">1995</a>)</span> and allows to define parameter boundaries.</p>
<p>In the optimization example we will use 7 parameters that are frequently used for model calibration with respect to simulated discharge. The <code>optim</code> function requires starting values (<code>par_init</code>) and in the case of <code>method = 'L-BFGS-B'</code> we can also define upper (<code>par_upr</code>) and lower (<code>par_lwr</code>) boundaries for the parameters to optimize. We name the parameter sets using the syntax for SWAT model parameters that is required for the <code>run_swat*()</code> functions (see the <a href="https://chrisschuerz.github.io/SWATplusR/articles/SWATplusR.html#model-parameter-alteration">Get started</a> section on ‘Model parameter alteration’ to learn more on parameter names):</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">par_names &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"cn2.hru | change = abschg"</span>,
               <span class="st">"lat_ttime.hru | change = absval"</span>,
               <span class="st">"lat_len.hru | change = absval"</span>,
               <span class="st">"k.sol | change = pctchg"</span>,
               <span class="st">"z.sol | change = pctchg"</span>,
               <span class="st">"epco.hru | change = absval"</span>,
               <span class="st">"esco.hru | change = absval"</span>)

par_init &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="dv">0</span>, <span class="dv">3</span>, <span class="dv">50</span>, <span class="dv">0</span> , <span class="dv">0</span>, <span class="fl">0.5</span>, <span class="fl">0.5</span>)
par_lwr  &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="op">-</span><span class="dv">15</span>, <span class="fl">0.5</span>,  <span class="dv">10</span>, <span class="op">-</span><span class="dv">50</span>, <span class="op">-</span><span class="dv">50</span>, <span class="dv">0</span>, <span class="dv">0</span>)
par_upr  &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>( <span class="dv">10</span>,  <span class="dv">50</span>, <span class="dv">100</span>,  <span class="dv">50</span>,  <span class="dv">50</span>, <span class="dv">1</span>, <span class="dv">1</span>)

<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(par_init) &lt;-<span class="st"> </span>par_names
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(par_lwr) &lt;-<span class="st"> </span>par_names
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/names">names</a></span>(par_upr) &lt;-<span class="st"> </span>par_names</code></pre></div>
<p>The defined optimization function <code>swat_optim()</code> can now be implemented in the algorithm as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opt_bfgs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/optim">optim</a></span>(<span class="dt">par =</span> par_init, <span class="dt">fn =</span> swat_optim, <span class="dt">method =</span> <span class="st">"L-BFGS-B"</span>,
                  <span class="dt">lower =</span> par_lwr, <span class="dt">upper =</span> par_upr, <span class="dt">obs =</span> q_obs<span class="op">$</span>discharge,
                  <span class="dt">control =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">maxit =</span> <span class="dv">100</span>))</code></pre></div>
<p>We omitted any feedback of the optimization in that case. If you want to get some feedback of the optimization routine you can set the control parameter <code>trace = 6</code> in the list of control parameters above. The result of the optimization is saved in a list object. Relevant information is given by the list entries <code>opt_bfgs$par</code> that provides the final optimum parameter set and <code>opt_bfgs$value</code> that shows the optimized objective criterion, in our case the NSE:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opt_bfgs<span class="op">$</span>par
<span class="co">#&gt;       cn2.hru | change = abschg lat_ttime.hru | change = absval </span>
<span class="co">#&gt;                     0.021059868                     1.025319757 </span>
<span class="co">#&gt;   lat_len.hru | change = absval         k.sol | change = pctchg </span>
<span class="co">#&gt;                    50.000004863                     0.006688686 </span>
<span class="co">#&gt;         z.sol | change = pctchg      epco.hru | change = absval </span>
<span class="co">#&gt;                     0.004704069                     0.460747484 </span>
<span class="co">#&gt;      esco.hru | change = absval </span>
<span class="co">#&gt;                     0.494337978</span>

opt_bfgs<span class="op">$</span>value
<span class="co">#&gt; [1] -0.7217028</span></code></pre></div>
<p>To visualize the discharge time series with the found parameter set we have to rerun the <code>swat_model()</code> we defined above with the optimum parameter set:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q_bfgs &lt;-<span class="st"> </span><span class="kw">swat_model</span>(opt_bfgs<span class="op">$</span>par)</code></pre></div>
<p>We will visualize the simulation with the optimized parameter set together with the observed discharge. We prepare our data with <code>dplyr</code> <span class="citation">(Wickham et al., <a href="#ref-Wickham2019">2019</a>)</span> and <code>tidyr</code> <span class="citation">(Wickham and Henry, <a href="#ref-Wickham2018a">2018</a>)</span> and plot it with <code>ggplot2</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q_plot &lt;-<span class="st"> </span>q_bfgs<span class="op">$</span>simulation <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">q_sim =</span> q_sim<span class="op">/</span><span class="fl">8.64</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/join.html">left_join</a></span>(., q_obs, <span class="dt">by =</span> <span class="st">"date"</span>) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(<span class="dt">q_obs =</span> discharge) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(., <span class="dt">key =</span> <span class="st">"variable"</span>, <span class="dt">value =</span> <span class="st">"discharge"</span>, <span class="op">-</span>date)

<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="dt">data =</span> q_plot) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> date, <span class="dt">y =</span> discharge, <span class="dt">col =</span> variable, <span class="dt">lty =</span> variable)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span>(<span class="dt">values =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"black"</span>, <span class="st">"tomato3"</span>)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</code></pre></div>
<p><img src="03_par_optim_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div id="parameter-optimization-with-sceoptim" class="section level2">
<h2 class="hasAnchor">
<a href="#parameter-optimization-with-sceoptim" class="anchor"></a>Parameter optimization with <code><a href="https://www.rdocumentation.org/packages/hydromad/topics/SCEoptim">SCEoptim()</a></code>
</h2>
<p>The implementation of the SCE algorithm provided by <code>hydromad</code> with the function <code><a href="https://www.rdocumentation.org/packages/hydromad/topics/SCEoptim">SCEoptim()</a></code> follows an almost identical syntax as the <code><a href="https://www.rdocumentation.org/packages/stats/topics/optim">optim()</a></code> function. Therefore, we can perform the optimization in almost the same manner as above. In <code><a href="https://www.rdocumentation.org/packages/hydromad/topics/SCEoptim">SCEoptim()</a></code> we will add however a few control arguments to define some settings in the optimization, such as the relative tolerance <code>reltol = 0.001</code> that is used to stop the optimization when the improvements in NSE are below the threshold, <code>tolsteps = 3</code> to stop after the third time the improvement in NSE was below the threshold, and <code>trace = 1</code> to get feedback from each optimization cycle. The optimization run looks as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">opt_sce  &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/hydromad/topics/SCEoptim">SCEoptim</a></span>(swat_optim, par_init, <span class="dt">lower =</span> par_lwr, <span class="dt">upper =</span> par_upr,
                     <span class="dt">control =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">reltol =</span> <span class="dv">10</span><span class="op">^</span>(<span class="op">-</span><span class="dv">3</span>), <span class="dt">tolsteps =</span> <span class="dv">3</span>, <span class="dt">trace =</span> <span class="dv">1</span>))
<span class="co">#&gt; Nr Iter  Nr Fun Eval    Current best function    Current worst function</span>
<span class="co">#&gt;     1       391                -0.736847                   497.542</span>
<span class="co">#&gt;     2       610                 -0.73938                   497.542</span>
<span class="co">#&gt;     3       888                -0.740991                   497.542</span>
<span class="co">#&gt;     4      1230                -0.741591                   497.542</span>
<span class="co">#&gt;     5      1532                -0.742106                   497.542</span>
<span class="co">#&gt;     6      1718                -0.742826                   497.542</span>
<span class="co">#&gt;     7      1882                -0.743112                   497.542</span>
<span class="co">#&gt;     8      2061                -0.744018                   497.542</span>
<span class="co">#&gt;     9      2272                -0.744347                   497.542</span>
<span class="co">#&gt;    10      2476                -0.744557                   497.542</span></code></pre></div>
<p>The optimization result with <code><a href="https://www.rdocumentation.org/packages/hydromad/topics/SCEoptim">SCEoptim()</a></code> provides more detailed information compared to <code><a href="https://www.rdocumentation.org/packages/stats/topics/optim">optim()</a></code>, such as the best parameter set of each iteration step. In our example you can see that all ten simulations actually resulted in almost the same model performance, a look at the respective parameter sets shows however, that some parameters strongly vary between these results. Therefore, it can be interesting to have a look on all ten simulation results. The best parameter set for each iteration step is saved in the variable <code>opt_sce$BESTMEM.ALL</code>. We will write them in a <code>tibble</code> <span class="citation">(Müller and Wickham, <a href="#ref-Mueller2019">2019</a>)</span> to use them in our simulations. In a next step we can run the SWAT+ model with these ten parameter sets. We will use parallel computing here to have shorter computation times:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">par_best &lt;-<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/reexports.html">as_tibble</a></span>(opt_sce<span class="op">$</span>BESTMEM.ALL)

q_sce &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_swatplus.html">run_swatplus</a></span>(<span class="dt">project_path =</span> plus_path,
                      <span class="dt">output =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">q_sim =</span> <span class="kw"><a href="../reference/define_output.html">define_output</a></span>(<span class="dt">file =</span> <span class="st">"channel"</span>,
                                                          <span class="dt">variable =</span> <span class="st">"flo_out"</span>,
                                                          <span class="dt">unit =</span> <span class="dv">1</span>)),
                      <span class="dt">parameter =</span> par_best,
                      <span class="dt">start_date =</span> <span class="st">"2000-01-01"</span>,
                      <span class="dt">end_date =</span> <span class="st">"2012-12-31"</span>,
                      <span class="dt">years_skip =</span> <span class="dv">3</span>,
                      <span class="dt">n_thread =</span> <span class="dv">4</span>)

<span class="co">#&gt; Building 4 threads in 'Define:/your/path/swatplus_demo/.model_run':</span>
<span class="co">#&gt;  Completed 4 threads in 0S                                                  </span>
<span class="co">#&gt; Performing 10 simulations on 4 cores:</span>
<span class="co">#&gt;  Completed 10 simulations in 8S</span></code></pre></div>
<p>To see the distribution of the parameters we first create dotty plots. To do that we have to add the optimized NSE values to the parameter table <code>par_best</code>. After that we agin transform our data and plot with <code>ggpot2</code>:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">par_plot &lt;-<span class="st"> </span>q_sce<span class="op">$</span>parameter<span class="op">$</span>values <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="dt">nse =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/apply">apply</a></span>(opt_sce<span class="op">$</span>POP.FIT.ALL, <span class="dv">1</span>, min),
         <span class="dt">run =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"run_"</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sprintf">sprintf</a></span>(<span class="st">"%02d"</span>, <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>))) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(<span class="dt">key =</span> <span class="st">"par"</span>, <span class="dt">value =</span> <span class="st">"val"</span>, <span class="op">-</span>nse, <span class="op">-</span>run)


<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(par_plot) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> val, <span class="dt">y =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/MathFun">abs</a></span>(nse), <span class="dt">col =</span> run)) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span>(.<span class="op">~</span>par, <span class="dt">scales =</span> <span class="st">"free"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</code></pre></div>
<p><img src="03_par_optim_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>The time series of the simulated discharges are plotted similarly to the plot for the results of <code>otim()</code>. Though, some modifications were necessary in the data preparation and the plot command itself to plot all ten simulations:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">sce_plot &lt;-<span class="st"> </span>q_sce<span class="op">$</span>simulation<span class="op">$</span>q_sim <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/mutate_all.html">mutate_if</a></span>(is.numeric, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="op">~</span>.<span class="op">/</span><span class="fl">8.64</span>)) <span class="op">%&gt;%</span>
<span class="st">  </span><span class="kw"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span>(., <span class="dt">key =</span> <span class="st">"variable"</span>, <span class="dt">value =</span> <span class="st">"discharge"</span>, <span class="op">-</span>date)

obs_plot &lt;-<span class="st"> </span><span class="kw"><a href="https://dplyr.tidyverse.org/reference/select.html">rename</a></span>(q_obs, <span class="dt">q_obs =</span> discharge)

<span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>() <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="dt">data =</span> obs_plot, <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> date, <span class="dt">y =</span> q_obs), <span class="dt">col =</span> <span class="st">"black"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span>(<span class="dt">data =</span> sce_plot,
            <span class="kw"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(<span class="dt">x =</span> date, <span class="dt">y =</span> discharge, <span class="dt">col =</span> variable), <span class="dt">alpha =</span> <span class="fl">0.75</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/scale_brewer.html">scale_color_brewer</a></span>(<span class="dt">palette =</span> <span class="st">"Paired"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span>(<span class="st">"discharge"</span>) <span class="op">+</span>
<span class="st">  </span><span class="kw"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_bw</a></span>()</code></pre></div>
<p><img src="03_par_optim_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Andrews2018">
<p>Andrews, F. and Guillaume, J.: Hydromad: Hydrological model assessment and development. [online] Available from: <a href="http://hydromad.catchment.org/" class="uri">http://hydromad.catchment.org/</a> (Accessed 5 March 2019), 2018.</p>
</div>
<div id="ref-Bass2019">
<p>Bass, B.: Tolson &amp; Shoemaker’s DDS Algorithm implementation in R. [online] Available from: <a href="https://github.com/bdb67/Dynamically-Dimensioned-Search" class="uri">https://github.com/bdb67/Dynamically-Dimensioned-Search</a> (Accessed 19 March 2019), 2014.</p>
</div>
<div id="ref-Bosch2007">
<p>Bosch, D. D., Sheridan, J. M., Lowrance, R. R., Hubbard, R. K., Strickland, T. C., Feyereisen, G. W. and Sullivan, D. G.: Little river experimental watershed database, Water Resources Research, 43(9), doi:<a href="https://doi.org/10.1029/2006wr005844">10.1029/2006wr005844</a>, 2007.</p>
</div>
<div id="ref-Byrd1995">
<p>Byrd, R. H., Lu, P., Nocedal, J. and Zhu, C.: A limited memory algorithm for bound constrained optimization, SIAM Journal on Scientific Computing, 16(5), 1190–1208, doi:<a href="https://doi.org/10.1137/0916069">10.1137/0916069</a>, 1995.</p>
</div>
<div id="ref-Duan1993">
<p>Duan, Q. Y., Gupta, V. K. and Sorooshian, S.: Shuffled complex evolution approach for effective and efficient global minimization, Journal of Optimization Theory and Applications, 76(3), 501–521, doi:<a href="https://doi.org/10.1007/bf00939380">10.1007/bf00939380</a>, 1993.</p>
</div>
<div id="ref-MZB2017">
<p>Mauricio Zambrano-Bigiarini: HydroGOF: Goodness-of-fit functions for comparison of simulated and observed hydrological time series., 2017.</p>
</div>
<div id="ref-Mueller2019">
<p>Müller, K. and Wickham, H.: Tibble: Simple data frames. [online] Available from: <a href="https://CRAN.R-project.org/package=tibble" class="uri">https://CRAN.R-project.org/package=tibble</a> (Accessed 5 March 2019), 2019.</p>
</div>
<div id="ref-Nash1970">
<p>Nash, J. E. and Sutcliffe, J. V.: River flow forecasting through conceptual models part I - A discussion of principles, Journal of Hydrology, 10(3), 282–290, doi:<a href="https://doi.org/10.1016/0022-1694(70)90255-6">10.1016/0022-1694(70)90255-6</a>, 1970.</p>
</div>
<div id="ref-Rcore2019">
<p>R Core Team: R: A language and environment for statistical computing., [online] Available from: <a href="https://www.r-project.org/" class="uri">https://www.r-project.org/</a> (Accessed 5 March 2019), 2019.</p>
</div>
<div id="ref-Tolson2007">
<p>Tolson, B. A. and Shoemaker, C. A.: Dynamically dimensioned search algorithm for computationally efficient watershed model calibration, Water Resources Research, 43(1), doi:<a href="https://doi.org/10.1029/2005wr004723">10.1029/2005wr004723</a>, 2007.</p>
</div>
<div id="ref-Wickham2018a">
<p>Wickham, H. and Henry, L.: Tidyr: Easily tidy data with ’spread()’ and ’gather()’ functions. [online] Available from: <a href="https://CRAN.R-project.org/package=tidyr" class="uri">https://CRAN.R-project.org/package=tidyr</a> (Accessed 3 May 2019), 2018.</p>
</div>
<div id="ref-Wickham2019">
<p>Wickham, H., François, R., Henry, L. and Müller, K.: Dplyr: A grammar of data manipulation. [online] Available from: <a href="https://CRAN.R-project.org/package=dplyr" class="uri">https://CRAN.R-project.org/package=dplyr</a> (Accessed 5 March 2019), 2019.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#r-packages">R packages</a></li>
      <li><a href="#loading-demo-data">Loading demo data</a></li>
      <li><a href="#definition-of-the-function-to-optimize">Definition of the function to optimize</a></li>
      <li><a href="#parameter-optimization-with-optim">Parameter optimization with <code>optim</code></a></li>
      <li><a href="#parameter-optimization-with-sceoptim">Parameter optimization with <code><a href="https://www-rdocumentation-org/packages/hydromad/topics/SCEoptim">SCEoptim()</a></code></a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Christoph Schuerz.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
