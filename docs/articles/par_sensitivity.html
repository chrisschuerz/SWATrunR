<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Parameter optimization • SWATplusR</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.3.7/sandstone/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Parameter optimization">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">SWATplusR</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.2.3.9001</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/SWATplusR.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/par_optim.html">Parameter optimization</a>
    </li>
    <li>
      <a href="../articles/par_sampl_calib.html">Parameter sampling and model calibration</a>
    </li>
    <li>
      <a href="../articles/par_sensitivity.html">Parameter optimization</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/chrisschuerz/SWATplusR">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Parameter optimization</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/chrisschuerz/SWATplusR/blob/master/vignettes/par_sensitivity.Rmd"><code>vignettes/par_sensitivity.Rmd</code></a></small>
      <div class="hidden name"><code>par_sensitivity.Rmd</code></div>

    </div>

    
    
<div id="r-packages" class="section level2">
<h2 class="hasAnchor">
<a href="#r-packages" class="anchor"></a>R packages</h2>
<p>Several R packages provide methods for sensitivity analysis. Two of the widely implemented packages are <code>sensitivity</code> <span class="citation">(Iooss et al., <a href="#ref-Iooss2018">2018</a>)</span> and <code>fast</code> <span class="citation">(Reusser, <a href="#ref-Reusser2015">2015</a>)</span>. <code>fast</code> provides the Fourier Amplitude Sensitivity Test (FAST) as single method for sensitivity analysis. The implementation of FAST, however, is very well suited to implement it in a workflow with <code>SWATplusR</code>. <code>sensitivity</code> is a very comprehensive collection of methods for sensitivity analysis (it actually includes the FAST method as well). The implementation in a workflow with <code>SWATplusR</code> is, however, less flexible. In this example we will use two frequently applied methods for sensitivity analysis that are provided by these two R packages, the method of Solbol <span class="citation">(<a href="#ref-Sobol1993">1993</a>)</span> provided by <code>sensitivity</code> and FAST <span class="citation">(Cukier et al., <a href="#ref-Cukier1973">1973</a>)</span> provided by <code>fast</code>. Most methods for sensitivity analysis require a scalar model result to assess the sensitivity of that output variable to changes in the inputs. Multiple goodness-of-fit functions are available from literature to evaluate simulated time series with observed time series of that variable that result in scalar values. The <code>hydroGOF</code> package <span class="citation">(Mauricio Zambrano-Bigiarini, <a href="#ref-MZB2017">2017</a>)</span> summarizes frequently used functions for the evaluation of time series of hydrological variables.</p>
<div id="package-installation" class="section level3">
<h3 class="hasAnchor">
<a href="#package-installation" class="anchor"></a>Package installation</h3>
<p>If you do not have installed any of the required R package, follow the instructions for the respective R package. All of the reuired R packages are available from CRAN and can be installed with the following commands:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"sensitivity"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"fast"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"hydroGOF"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"dplyr"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"tidyr"</span>)
<span class="kw"><a href="https://www.rdocumentation.org/packages/utils/topics/install.packages">install.packages</a></span>(<span class="st">"ggplot2"</span>)</code></pre></div>
</div>
<div id="loading-r-packages" class="section level3">
<h3 class="hasAnchor">
<a href="#loading-r-packages" class="anchor"></a>Loading R packages</h3>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(SWATplusR)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(sensitivity)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(fast)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(hydroGOF)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(dplyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(lubridate)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(tidyr)
<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/library">library</a></span>(ggplot2)</code></pre></div>
</div>
</div>
<div id="loading-demo-data" class="section level2">
<h2 class="hasAnchor">
<a href="#loading-demo-data" class="anchor"></a>Loading demo data</h2>
<p>The sensitivity analysis example uses the SWAT+ demo project available from <code>SWATplusR</code>. The demo project is a simple model setup of a head watershed of the Little River Experimental Watershed <span class="citation">(LREW; Bosch et al., <a href="#ref-Bosch2007">2007</a>)</span>. You can load the to your hard drive as follows:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># The path where the SWAT demo project will be written</span>
demo_path &lt;-<span class="st"> "Define:/your/path"</span>

<span class="co"># Loading the SWAT+ demo project on your hard drive</span>
path_plus &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_demo.html">load_demo</a></span>(<span class="dt">dataset =</span> <span class="st">"project"</span>,
                       <span class="dt">swat_version =</span> <span class="st">"plus"</span>,
                       <span class="dt">path =</span> demo_path)</code></pre></div>
<p><code>SWATplusR</code> also provides observation data of daily discharge records at the main outlet of the demo for the time period 1968-01-01 until 2012-12-31. We will use the observation data to evaluate the model in each optimization step. The model will be evaluated for the time period 2003-01-01 to 2012-12-31. Therefore, we load the demo data and limit it to this time period:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">q_obs &lt;-<span class="st"> </span><span class="kw"><a href="../reference/load_demo.html">load_demo</a></span>(<span class="dt">dataset =</span> <span class="st">"observation"</span>)

q_obs &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/filter">filter</a></span>(q_obs, date <span class="op">&gt;=</span><span class="st"> </span><span class="kw">ymd</span>(<span class="st">"2003-01-01"</span>),
                       date <span class="op">&lt;=</span><span class="st"> "2012-12-31"</span>)</code></pre></div>
</div>
<div id="definition-of-the-function-to-optimize" class="section level2">
<h2 class="hasAnchor">
<a href="#definition-of-the-function-to-optimize" class="anchor"></a>Definition of the function to optimize</h2>
<p>Most optimizers require a function as an input argument that uses a parameter set as input and returns a scalar value as a result. To use the <code><a href="../reference/run_swatplus.html">run_swatplus()</a></code> function in the optimization we wrap a function around the SWAT model execution that will be implemented in the optimizer to search the optimum parameter set that minimizes the return value (minimization is usually the default option in optimizers). Below you see how you can implement the model execution into a function that can be optimized:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">swat_optim &lt;-<span class="st"> </span><span class="cf">function</span>(par, obs) {
  q_sim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_swatplus.html">run_swatplus</a></span>(<span class="dt">project_path =</span> <span class="st">"C:/swatplus_demo"</span>,
                        <span class="dt">output =</span> <span class="kw"><a href="../reference/define_output.html">define_output</a></span>(<span class="dt">file =</span> <span class="st">"channel"</span>,
                                              <span class="dt">variable =</span> <span class="st">"flo_out"</span>,
                                              <span class="dt">unit =</span> <span class="dv">1</span>),
                        <span class="dt">parameter =</span> par,
                        <span class="dt">start_date =</span> <span class="st">"2000-01-01"</span>,
                        <span class="dt">end_date =</span> <span class="st">"2012-12-31"</span>,
                        <span class="dt">years_skip =</span> <span class="dv">3</span>,
                        <span class="dt">quiet =</span> <span class="ot">TRUE</span>)

  nse_q &lt;-<span class="st"> </span><span class="op">-</span><span class="st"> </span><span class="kw">NSE</span>(q_sim<span class="op">$</span>simulation<span class="op">$</span>flo_out<span class="op">/</span><span class="fl">8.64</span>, obs)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(nse_q)
}

swat_optim &lt;-<span class="st"> </span><span class="cf">function</span>(par, obs) {
  q_sim &lt;-<span class="st"> </span><span class="kw"><a href="../reference/run_swatplus.html">run_swatplus</a></span>(<span class="dt">project_path =</span> <span class="st">"C:/swatplus_demo"</span>,
                        <span class="dt">output =</span> <span class="kw"><a href="../reference/define_output.html">define_output</a></span>(<span class="dt">file =</span> <span class="st">"channel"</span>,
                                              <span class="dt">variable =</span> <span class="st">"flo_out"</span>,
                                              <span class="dt">unit =</span> <span class="dv">1</span>),
                        <span class="dt">parameter =</span> par,
                        <span class="dt">start_date =</span> <span class="st">"2000-01-01"</span>,
                        <span class="dt">end_date =</span> <span class="st">"2012-12-31"</span>,
                        <span class="dt">years_skip =</span> <span class="dv">3</span>,
                        <span class="dt">quiet =</span> <span class="ot">TRUE</span>)

  nse_q &lt;-<span class="st"> </span><span class="op">-</span><span class="st"> </span><span class="kw">NSE</span>(q_sim<span class="op">$</span>simulation<span class="op">$</span>flo_out<span class="op">/</span><span class="fl">8.64</span>, obs)
  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(nse_q)
  }</code></pre></div>
<p>We defined a function that has one input argument <code>par</code> that is the named parameter vector that will be passed to <code><a href="../reference/run_swatplus.html">run_swatplus()</a></code>. The simulation will return the discharge at the main outlet (<code>unit = 1</code>) for the time period 2003-01-01 to 2012-12-31 (considering the <code>years_skip = 3</code> as warm up period). In this case we set the function to be <code>quiet = TRUE</code>. In a next step the function uses the observed discharge values from <code>q_obs$q_out</code> for the same period and evaluate the simulated discharges using the <code>NSE()</code> from the package <code>hydroGOF</code> that is then returned as a single value. You can see that we implemented the negative NSE as we will minimize with <code><a href="https://www.rdocumentation.org/packages/stats/topics/optim">optim()</a></code></p>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-Bosch2007">
<p>Bosch, D. D., Sheridan, J. M., Lowrance, R. R., Hubbard, R. K., Strickland, T. C., Feyereisen, G. W. and Sullivan, D. G.: Little river experimental watershed database, Water Resources Research, 43(9), doi:<a href="https://doi.org/10.1029/2006wr005844">10.1029/2006wr005844</a>, 2007.</p>
</div>
<div id="ref-Cukier1973">
<p>Cukier, R. I., Fortuin, C. M., Shuler, K. E., Petschek, A. G. and Schaibly, J. H.: Study of the sensitivity of coupled reaction systems to uncertainties in rate coefficients. i theory, The Journal of Chemical Physics, 59(8), 3873–3878, doi:<a href="https://doi.org/10.1063/1.1680571">10.1063/1.1680571</a>, 1973.</p>
</div>
<div id="ref-Iooss2018">
<p>Iooss, B., Janon, A., Pujol, G., Khalid Boumhaout, Veiga, S. D., Delage, T., Fruth, J., Gilquin, L., Guillaume, J., Le Gratiet, L., Lemaitre, P., Nelson, B. L., Monari, F., Oomen, R., Rakovec, O., Ramos, B., Roustant, O., Song, E., Staum, J., Sueur, R., Touati, T. and Weber, F.: Sensitivity: Global sensitivity analysis of model outputs. [online] Available from: <a href="https://CRAN.R-project.org/package=sensitivity" class="uri">https://CRAN.R-project.org/package=sensitivity</a> (Accessed 5 March 2019), 2018.</p>
</div>
<div id="ref-MZB2017">
<p>Mauricio Zambrano-Bigiarini: HydroGOF: Goodness-of-fit functions for comparison of simulated and observed hydrological time series., 2017.</p>
</div>
<div id="ref-Reusser2015">
<p>Reusser, D.: Fast: Implementation of the fourier amplitude sensitivity test (fast). [online] Available from: <a href="https://CRAN.R-project.org/package=fast" class="uri">https://CRAN.R-project.org/package=fast</a> (Accessed 5 March 2019), 2015.</p>
</div>
<div id="ref-Sobol1993">
<p>Sobol, I. M.: Sensitivity analysis for nonlinear mathematical models, Mathematical Modelling and Computational Experiments, 4(1), 407–414, doi:<a href="https://doi.org/10.18287/0134-2452-2015-39-4-459-461.">10.18287/0134-2452-2015-39-4-459-461.</a>, 1993.</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#r-packages">R packages</a></li>
      <li><a href="#loading-demo-data">Loading demo data</a></li>
      <li><a href="#definition-of-the-function-to-optimize">Definition of the function to optimize</a></li>
      <li><a href="#references">References</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Christoph Schuerz.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
